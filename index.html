<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>The little guy</title>
        <script src="//cdn.jsdelivr.net/phaser/2.5.0/phaser.min.js"></script>

        <!--carregando novos scripts-->
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        //instancia o phaser
        var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
        
        //variaveis de objetos
        var player;
        var platforms;
        var spaceKey;
        var textPoints;

        //variaveis do player
        var jumpForce = 350;
        var velocityPlayer = 150;
        var lifePlayer = 3; //não utilizada ainda
        var pointsPlayer = 0;

        //carrega assets no jogo
        function preload () {
            game.load.image('sky', 'assets/sky.png');
            game.load.image('ground', 'assets/platform.png');
            game.load.image('star', 'assets/star.png');
            game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
        }

        //cria os assets dentro do jogo 
        function create () {
            //utilizando e adicionando fisica (colisão) ao jogo
            game.physics.startSystem(Phaser.Physics.ARCADE);

            //registrando uma tecla        propriedade do phase da tecla desejada
            spaceKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
            
            //              x  y  objeto
            game.add.sprite(0, 0, 'sky'); //background

            //criando texto de pontos
            textPoints = game.add.text(80, 30, "Apenas Teste", {
                 font: "35px Arial",
                 fill: "#ff0044",
                 align: "center"
            });
            textPoints.anchor.setTo(0.5, 0.5); //ancorando texto
            
            //grupo de plataformas contendo o chao onde poderemos pular
            platforms = game.add.group();
            platforms.enableBody = true; //adicionando fisica para qualquer objeto dentro desse grupo (plataforms)
            
            //grupo de estrelas
            stars = game.add.group();
            stars.enableBody = true;

            //criando as estrelas
            for(var i = 0; i < 12; i++){
                var star = stars.create (i * 70, 0, 'star');     
                star.body.gravity.y = 1 + Math.random() * 10;    //gravidade atuando randomicamente para cada estrela
                star.body.bounce.y = 0.7 + Math.random() * 0.2;  //estrelas quicando no chão randomicamente
            }

            //criando chao (acredito que já com a colisao)            
            //                             x            y             nome do objeto
            var ground = platforms.create(0, game.world.height - 64, 'ground');
            ground.scale.setTo(2, 2);      //redimencionando para que fique na parte inferior
            ground.body.immovable = true; //fazendo objeto ficar parado para que não caia quando houver colisao ao pular em cima

            //criando 'plataformas'
            var ledge = platforms.create(400, 400, 'ground');
            ledge.body.immovable = true;

            ledge = platforms.create(-150, 250, 'ground');
            ledge.body.immovable = true;

            //criando jogador
            player = game.add.sprite(32, game.world.height - 150, 'dude');
            game.physics.arcade.enable(player); //habilitando a fisica ao objeto do jogador
            player.body.bounce.y = 0.1;         //adicionando propriedades de fisica ao jogador (bounce vai de 0 a 1)
            player.body.gravity.y = 400;
            player.body.collideWorldBounds = true;

            /***qualquer objeto que tenha que ter animação, deverá ser carregado como SPRITESHEET em preload()***/  
            //adicionando animações ao jogador, esquerda e direita
            //               nome animacao / todos os frames dessa animação / velocidade animação / loop sim ou não
            player.animations.add('left', [0, 1, 2, 3], 10, true);
            player.animations.add('right', [5, 6, 7, 8], 10, true);
            
            //detectando as setas do teclado
            cursors = game.input.keyboard.createCursorKeys();
        }

        //atualiza os assets do jogo
        function update(){
            //escrevendo e mostrando os pontos
            textPoints.text = "Pontos: " + pointsPlayer;

            //Fazendo player andar e parar
            movimentPlayer();

            //Fazendo player Pular
            jumpPlayer();

            //colidindo dois objetos (estrela e chão)
            game.physics.arcade.collide(stars, platforms);
            
            //verificando se o player está sobrepondo (passando por cima ) da estrela e chamando funcao 'collectStar' que vai fazer o jogador coletar a estrela
            game.physics.arcade.overlap(player, stars, collectStar, null, this);
        }
    
        function movimentPlayer(){
            if(cursors.left.isDown){
                player.body.velocity.x =- velocityPlayer;  //velocidade
                player.animations.play('left');            //tocando animação
            } 
            else if (cursors.right.isDown){
                player.body.velocity.x = velocityPlayer;
                player.animations.play('right');
            }
            else{  
                player.body.velocity.x = 0; //fazendo player parar, caso nenhuma tecla esteja sendo pressionada
                player.animations.stop();   //parando animação
                player.frame = 4;           //mudando o frame para 'parado' que é o frame 4
            }
        }

        function jumpPlayer(){
            //colidindo jogador com o chão
            //                                      primeiro objeto e segundo  
            //obs : especialmente aqui, temos uma variavel para detectar se o jogador colidiu com o chão, para então habilitar o pulo
            var hitPlataform = game.physics.arcade.collide(player, platforms);     

            //se apertar o de espaço e estiver tocando no chão e em uma plataforma, pule
            if(spaceKey.isDown && player.body.touching.down && hitPlataform){
               player.body.velocity.y =- jumpForce;  
            }
        }
        
        function collectStar(player, star){
            //deletando objeto a ser coletado
            star.kill();
            pointsPlayer = pointsPlayer + 10; //adicionando pontos
        }

    };

    </script>

    </body>
</html>